<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#166534" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="modulepreload" href="/vendor/firebase/9.6.0/firebase-app.js" crossorigin>
  <link rel="modulepreload" href="/vendor/firebase/9.6.0/firebase-auth.js" crossorigin>
  <link rel="modulepreload" href="/vendor/firebase/9.6.0/firebase-firestore.js" crossorigin>
  <link rel="modulepreload" href="/vendor/firebase/9.6.1/firebase-messaging.js" crossorigin>
  <script type="module" src="js/app.js"></script>
  <script src="/vendor/tailwind/tailwind.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link rel="stylesheet" href="/vendor/leaflet/leaflet.css" />
  <script src="/vendor/leaflet/leaflet.js" defer></script>
  <link rel="stylesheet" href="style.css" />
  <title>Orgânia - Painel do Agrônomo</title>
</head>
<body class="bg-gray-100 text-gray-800">
  <div id="dashboard-agronomo-marker" hidden></div>

  <header class="bg-white shadow-md sticky top-0 z-20">
    <div class="px-4 py-3 flex justify-between items-center">
      <h1 class="text-lg font-bold" style="color: var(--brand-green);">Painel do Agrônomo</h1>
      <div class="flex items-center space-x-2">
        <button id="exportOfflineBtn" class="px-3 py-1.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-sm">Exportar</button>
        <button onclick="logout()" class="px-3 py-1.5 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 text-sm">Sair</button>
      </div>
    </div>
  </header>

  <main id="agroMain" class="pb-16">
    <section id="view-home" data-view>
      <h2 class="p-4 text-xl font-semibold tracking-tight text-gray-800">Home</h2>
      <div id="kpiGrid" class="page-container grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <div class="kpi-card bg-white rounded-2xl shadow-sm border border-gray-100 opacity-0 translate-y-4 stagger-item">
          <div class="kpi-icon text-emerald-700"><i class="fas fa-sack-dollar" aria-hidden="true"></i></div>
          <div class="kpi-text">
            <div class="kpi-title">Vendas (t)</div>
            <div id="kpiSales" class="kpi-value"></div>
          </div>
        </div>
        <div class="kpi-card bg-white rounded-2xl shadow-sm border border-gray-100 opacity-0 translate-y-4 stagger-item">
          <div class="kpi-icon text-emerald-700"><i class="fas fa-user-check" aria-hidden="true"></i></div>
          <div class="kpi-text">
            <div class="kpi-title">Visitas</div>
            <div id="kpiVisits" class="kpi-value"></div>
          </div>
        </div>
        <div class="kpi-card bg-white rounded-2xl shadow-sm border border-gray-100 opacity-0 translate-y-4 stagger-item">
          <div class="kpi-icon text-emerald-700"><i class="fas fa-user-plus" aria-hidden="true"></i></div>
          <div class="kpi-text">
            <div class="kpi-title">Novos Leads</div>
            <div id="kpiLeads" class="kpi-value"></div>
          </div>
        </div>
        <div class="kpi-card bg-white rounded-2xl shadow-sm border border-gray-100 opacity-0 translate-y-4 stagger-item">
          <div id="kpiAgenda" class="kpi-value text-3xl font-bold text-gray-800 rounded group-hover:ring-1 group-hover:ring-green-600/20"></div>
          <div class="text-sm text-gray-500">Pendências (7d)</div>
        </div>
      </div>

      <div id="chartsSection" class="page-container grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <div id="chartSales" class="card-soft opacity-0 translate-y-4 stagger-item"></div>
        <div id="chartVisits" class="card-soft opacity-0 translate-y-4 stagger-item"></div>
        <div id="chartLeadsFunnel" class="card-soft flex gap-2 opacity-0 translate-y-4 stagger-item"></div>
      </div>
      <div id="homeShortcuts" class="page-container grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4">
        <button
          id="quickHomeAddContato"
          aria-label="Adicionar contato"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
            <circle cx="12" cy="7" r="4" />
            <line x1="20" y1="8" x2="20" y2="14" />
            <line x1="17" y1="11" x2="23" y2="11" />
          </svg>
          <span class="text-sm text-gray-500">Adicionar contato</span>
        </button>
        <button
          id="quickHomeAddVisit"
          aria-label="Registrar Visita"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21s-7-7.58-7-12.5a7 7 0 1114 0C19 13.42 12 21 12 21z" />
            <circle cx="12" cy="8.5" r="3.5" />
          </svg>
          <span class="text-sm text-gray-500">Registrar Visita</span>
        </button>
        <button
          id="quickHomeOpenMap"
          aria-label="Abrir Mapa"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 3l6 2 6-2v16l-6 2-6-2-6 2V5l6-2v16" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 5v16" />
          </svg>
          <span class="text-sm text-gray-500">Abrir Mapa</span>
        </button>
        <button
          id="quickHomeOpenContacts"
          aria-label="Abrir Contatos"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 21v-2a4 4 0 00-4-4h-2" />
            <circle cx="12" cy="7" r="4" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 21v-2a4 4 0 00-3-3.87" />
            <circle cx="6" cy="10" r="3" />
          </svg>
          <span class="text-sm text-gray-500">Abrir Contatos</span>
        </button>
        <button
          id="quickHomeGotoAgenda"
          aria-label="Agenda (7d)"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 7h18M7 3v4m10-4v4M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z" />
          </svg>
          <span class="text-sm text-gray-500">Agenda (7d)</span>
        </button>
        <button
          id="quickHomeSyncNow"
          aria-label="Sincronizar agora"
          class="w-full flex flex-col items-center justify-center gap-1 p-4 bg-white rounded-2xl shadow-md hover:shadow-lg transform transition duration-200 ease-in-out hover:scale-105 opacity-0 translate-y-4 stagger-item"
        >
          <svg class="w-6 h-6 text-emerald-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M20 8a8 8 0 10-8 8" />
          </svg>
          <span class="text-sm text-gray-500">Sincronizar</span>
        </button>
      </div>
      <div id="agendaHome" class="page-container card-soft opacity-0 translate-y-4 stagger-item">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-xl font-semibold tracking-tight text-gray-800">Próximos compromissos</h3>
          <select id="agendaPeriod" class="input w-32">
            <option value="7">7 dias</option>
            <option value="30">30 dias</option>
            <option value="90">90 dias</option>
          </select>
        </div>
          <ul id="agendaList" class="space-y-3" aria-live="polite"></ul>
          <div
            id="agendaEmpty"
            class="hidden text-center bg-white border border-dashed rounded-2xl p-6 text-gray-500"
            aria-live="polite"
          >
            <i class="fas fa-calendar text-3xl mb-2 text-gray-400" aria-hidden="true"></i>
            <p class="mb-2">Nenhum compromisso futuro.</p>
            <button id="btnAgendaAddVisit" class="btn-primary">Registrar visita</button>
          </div>
        </div>
    </section>
    <section id="view-contatos" data-view class="hidden">
      <h2 class="sr-only">Contatos</h2>
      <div class="page-container flex gap-2">
        <input id="contactsSearch" type="text" class="input flex-1" placeholder="Buscar" />
        <div class="flex gap-2">
          <button id="contactsFilterAll" class="chip chip--filter filter-active">Todos</button>
          <button id="contactsFilterClients" class="chip chip--filter">Clientes</button>
          <button id="contactsFilterLeads" class="chip chip--filter">Leads</button>
        </div>
      </div>
      <div id="contactsList" class="page-container grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
      <div id="contactsEmpty" class="page-container empty-state hidden text-center">
        <p class="mb-2">Nenhum contato encontrado.</p>
        <button id="btnContactsQuickAdd" class="btn-primary">Adicionar contato</button>
      </div>
    </section>
    <section id="view-clientes" data-view class="hidden">
      <h2 class="sr-only">Clientes</h2>
      <div id="clientsSummary" class="page-container text-sm text-gray-500">Ativos: <span id="clientsTotal">0</span></div>
      <div class="page-container flex gap-2">
        <input id="clientsSearch" type="text" class="input flex-1" placeholder="Buscar por nome" />
        <select id="clientsSort" class="input w-40">
          <option value="az">A-Z</option>
          <option value="recent">Mais recentes</option>
          <option value="visits">Mais visitas</option>
        </select>
      </div>
      <div class="page-container flex gap-2" id="clientsFilterChips">
        <button data-filter="active" class="chip chip--filter filter-active">Ativos</button>
        <button data-filter="all" class="chip chip--filter">Todos</button>
      </div>
      <div id="clientsList" class="page-container card-soft divide-y"></div>
      <div id="clientsEmpty" class="page-container empty-state hidden text-center">
        <p class="mb-2">Nenhum cliente encontrado.</p>
        <button id="btnClientsQuickAdd" class="btn-primary">Cadastrar cliente</button>
      </div>
    </section>
    <section id="view-leads" data-view class="hidden">
      <h2 class="sr-only">Leads</h2>
      <div id="leadsSummary" class="page-container text-sm text-gray-500 flex gap-4">
        <div>Interessado: <span id="leadCountInteressado">0</span></div>
        <div>Na dúvida: <span id="leadCountNaDuvida">0</span></div>
        <div>Sem interesse: <span id="leadCountSemInteresse">0</span></div>
      </div>
      <div class="page-container flex gap-2">
        <input id="leadsSearch" type="text" class="input flex-1" placeholder="Buscar por nome" />
        <select id="leadsSort" class="input w-40">
          <option value="az">A-Z</option>
          <option value="recent">Mais recentes</option>
          <option value="visits">Mais visitas</option>
        </select>
      </div>
      <div class="page-container flex gap-2" id="leadsFilterChips">
        <button data-filter="all" class="chip chip--filter filter-active">Todos</button>
        <button data-filter="Interessado" class="chip chip--filter">Interessado</button>
        <button data-filter="Na dúvida" class="chip chip--filter">Na dúvida</button>
        <button data-filter="Sem interesse" class="chip chip--filter">Sem interesse</button>
      </div>
      <div id="leadsList" class="page-container card-soft divide-y"></div>
      <div id="leadsEmpty" class="page-container empty-state hidden text-center">
        <p class="mb-2">Nenhum lead encontrado.</p>
        <button id="btnLeadsQuickAdd" class="btn-primary">Cadastrar lead</button>
      </div>
    </section>
    <section id="view-mapa" data-view class="hidden">
      <div id="mapFilters" class="page-container flex gap-2" role="radiogroup">
        <button id="mapFilterAll" class="chip chip--filter filter-active" aria-pressed="true">Todos</button>
        <button id="mapFilterClients" class="chip chip--filter" aria-pressed="false">Clientes</button>
        <button id="mapFilterLeads" class="chip chip--filter" aria-pressed="false">Leads</button>
      </div>
      <div id="agroMap"></div>
    </section>
    <section id="view-historico" data-view class="hidden">
      <h2 class="p-4 text-xl font-semibold tracking-tight">Histórico</h2>
      <div id="historyFilters" class="px-4 flex gap-2 mb-4" role="radiogroup">
        <button id="historyFilterAll" class="chip chip--filter filter-active" aria-pressed="true">Todos</button>
        <button id="historyFilterVisits" class="chip chip--filter" aria-pressed="false">Visitas</button>
        <button id="historyFilterAdds" class="chip chip--filter" aria-pressed="false">Cadastros</button>
      </div>
      <div id="historyTimeline" class="page-container card-soft divide-y"></div>
    </section>
  </main>

  <nav id="bottomBar" class="bottom-bar">
    <button data-nav="#home" aria-label="Home">
      <i class="fas fa-home" aria-hidden="true"></i>
      <span class="sr-only">Home</span>
    </button>
    <button data-nav="#contatos" aria-label="Contatos">
      <i class="fas fa-users" aria-hidden="true"></i>
      <span class="sr-only">Contatos</span>
    </button>
    <button id="navPlus" class="plus-btn" aria-label="Ações rápidas">
      <i class="fas fa-plus" aria-hidden="true"></i>
      <span class="sr-only">Ações rápidas</span>
    </button>
    <button data-nav="#mapa" aria-label="Mapa">
      <i class="fas fa-map" aria-hidden="true"></i>
      <span class="sr-only">Mapa</span>
    </button>
    <button data-nav="#historico" aria-label="Histórico">
      <i class="fas fa-history" aria-hidden="true"></i>
      <span class="sr-only">Histórico</span>
    </button>
  </nav>

  <div id="quickActionsModal" class="modal hidden">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="quickActionsTitle">
      <h3 id="quickActionsTitle" class="mb-4 font-semibold">Ações Rápidas</h3>
      <div class="flex flex-col gap-2 mb-4">
        <button id="btnQuickAddContato" class="btn-primary">Adicionar contato</button>
        <button id="btnQuickRegVisita" class="btn-primary">Registrar Visita</button>
      </div>
      <button id="btnQuickClose" class="btn-secondary w-full">Fechar</button>
    </div>
  </div>

  <div id="visitModal" class="modal hidden">
    <div class="modal-card max-w-xl w-full" role="dialog" aria-modal="true" aria-labelledby="visitModalTitle">
      <h3 id="visitModalTitle" class="mb-4 font-semibold">Registrar Visita</h3>
      <form id="visitForm" class="grid gap-4">
        <div>
          <label><input type="radio" name="visitTarget" value="cliente" checked /> Cliente</label>
          <label class="ml-4"><input type="radio" name="visitTarget" value="lead" /> Lead</label>
        </div>
        <div class="field">
          <label for="visitTargetSelect">Selecione</label>
          <select id="visitTargetSelect" class="input"></select>
        </div>
        <button type="button" id="btnVisitQuickCreate" class="btn-secondary">Cadastrar novo (rápido)</button>
        <div class="field">
          <label for="visitAt">Data/Hora</label>
          <input id="visitAt" type="datetime-local" class="input" required readonly />
        </div>
        <div class="field">
          <label for="visitNotes">Descrição*</label>
          <textarea id="visitNotes" class="input" required></textarea>
        </div>
        <div id="leadExtras" class="hidden">
          <div class="field">
            <label for="visitInterest">Interesse*</label>
            <select id="visitInterest" class="input">
              <option value="">Selecione</option>
              <option value="Interessado">Interessado</option>
              <option value="Na dúvida">Na dúvida</option>
              <option value="Sem interesse">Sem interesse</option>
            </select>
          </div>
          <div class="field">
            <label for="visitSale">Venda?</label>
            <select id="visitSale" class="input">
              <option value="nao">Não</option>
              <option value="sim">Sim</option>
            </select>
          </div>
          <div id="leadFollowUp" class="hidden">
            <div class="field">
              <label class="inline-flex items-center">
                <input id="visitTaskEnable" type="checkbox" class="mr-2" />
                Agendar tarefa?
              </label>
            </div>
            <div id="visitTaskFields" class="grid gap-2 hidden">
              <div class="field">
                <label for="visitTaskWhen">Data/Hora</label>
                <input id="visitTaskWhen" type="datetime-local" class="input" />
              </div>
              <div class="field">
                <label for="visitTaskTitle">Ttulo da tarefa</label>
                <input id="visitTaskTitle" class="input" placeholder="Ex.: Retornar contato" />
              </div>
            </div>
          </div>
          <div id="leadReason" class="hidden">
            <div class="field">
              <label for="visitReason">Motivo</label>
              <input id="visitReason" class="input" />
            </div>
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" id="btnVisitCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="saleModal" class="modal hidden">
    <div class="modal-card max-w-md w-full" role="dialog" aria-modal="true" aria-labelledby="saleModalTitle">
      <h3 id="saleModalTitle" class="mb-4 font-semibold">Registrar Venda</h3>
      <form id="saleForm" class="grid gap-4">
        <div class="field">
          <label for="saleFormula">Fórmula</label>
          <select id="saleFormula" class="input"></select>
        </div>
        <div class="field">
          <label for="saleTons">Toneladas</label>
          <input id="saleTons" type="number" min="0.1" step="0.1" class="input" required />
        </div>
        <div class="field">
          <label for="saleNote">Observação</label>
          <textarea id="saleNote" class="input"></textarea>
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" id="btnSaleCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="leadVisitModal" class="modal hidden">
    <div class="modal-card max-w-md w-full" role="dialog" aria-modal="true" aria-labelledby="leadVisitModalTitle">
      <h3 id="leadVisitModalTitle" class="mb-4 font-semibold">Registrar Visita</h3>
      <form id="leadVisitForm" class="grid gap-4">
        <div class="field">
          <label for="leadVisitDate">Data/Hora</label>
          <input id="leadVisitDate" type="datetime-local" class="input" required readonly />
        </div>
        <div class="field">
          <label for="leadVisitSummary">Resumo*</label>
          <textarea id="leadVisitSummary" class="input" required></textarea>
        </div>
        <div class="field">
          <label for="leadVisitNotes">Notas</label>
          <textarea id="leadVisitNotes" class="input"></textarea>
        </div>
        <div class="field">
          <label for="leadVisitOutcome">Resultado</label>
          <select id="leadVisitOutcome" class="input">
            <option value="realizada">Realizada</option>
            <option value="reagendada">Reagendada</option>
            <option value="cancelada">Cancelada</option>
            <option value="sem_contato">Sem contato</option>
          </select>
        </div>
        <div class="field">
          <label class="inline-flex items-center">
            <input id="leadVisitTaskEnable" type="checkbox" class="mr-2" />
            Agendar tarefa?
          </label>
        </div>
        <div id="leadVisitTaskFields" class="grid gap-2 hidden">
          <div class="field">
            <label for="leadVisitTaskWhen">Data/Hora</label>
            <input id="leadVisitTaskWhen" type="datetime-local" class="input" />
          </div>
          <div class="field">
            <label for="leadVisitTaskTitle">Ttulo da tarefa</label>
            <input id="leadVisitTaskTitle" class="input" placeholder="Ex.: Retornar contato" />
          </div>
        </div>
        <div class="field">
          <label for="leadVisitNextStep">Próximo passo</label>
          <input id="leadVisitNextStep" class="input" />
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" id="btnLeadVisitCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="quickCreateModal" class="modal hidden">
    <div class="modal-card max-w-xl w-full" role="dialog" aria-modal="true" aria-labelledby="quickCreateModalTitle">
      <h3 id="quickCreateModalTitle" class="mb-4 font-semibold">Cadastro Rápido</h3>
      <form id="quickCreateForm" class="grid gap-4">
        <div>
          <label><input type="radio" name="quickType" value="cliente" checked /> Cliente</label>
          <label class="ml-4"><input type="radio" name="quickType" value="lead" /> Lead</label>
        </div>
        <div class="field">
          <label for="qcName">Nome*</label>
          <input id="qcName" class="input" required />
        </div>
        <div class="field">
          <label for="qcFarm">Fazenda*</label>
          <input id="qcFarm" class="input" required />
        </div>
        <div class="field">
          <label for="qcNotes">Notas</label>
          <textarea id="qcNotes" class="input"></textarea>
        </div>
        <div class="field">
          <label>Localização</label>
          <button type="button" id="qcUseLocation" class="btn-secondary mb-2">Usar minha localização</button>
          <div class="flex gap-2">
            <input id="qcLat" class="input flex-1" placeholder="Lat" readonly />
            <input id="qcLng" class="input flex-1" placeholder="Lng" readonly />
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button type="button" id="btnQCCancel" class="btn-secondary">Cancelar</button>
          <button type="submit" class="btn-primary">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/__/firebase/9.6.1/firebase-app-compat.js"></script>
  <script src="/__/firebase/9.6.1/firebase-auth-compat.js"></script>
  <script src="/__/firebase/9.6.1/firebase-firestore-compat.js"></script>
  <script src="/__/firebase/init.js"></script>
  <script type="module" src="js/services/auth.js"></script>
  <script src="/vendor/chart/chart.umd.js" defer></script>
  <script type="module" src="js/pages/dashboard-agronomo.js"></script>
</body>
</html>
